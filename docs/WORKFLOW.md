# 診療フローガイド

## フロー概要

**患者の基本フロー:** 予約 → 受付 → 診療 → 会計

| ステップ | ステータス | 患者側オプション |
|---------|-----------|----------------|
| 予約 | SCHEDULED | Web予約 (Portal) |
| 受付 | WAITING | Web問診入力 |
| 診療 | IN_PROGRESS | - |
| 会計 | COMPLETED | - |

---

## 1. 対面診療フロー

### 1.1 新規患者（初診）

1. **患者来院**

2. **受付** `/patients` → 「新規患者登録」
   - 基本情報入力 (氏名、生年月日、性別、連絡先)
   - 保険証確認・登録
   - 患者番号自動発行

3. **予約登録** `/appointments` → 「新規予約」
   - 患者選択
   - 担当医選択
   - 診療種別: 初診 (INITIAL)
   - 日時設定

4. **受付ボタン** → ステータス: WAITING

5. **診療開始** → ステータス: IN_PROGRESS

6. **カルテ記載** `/records` → 「新規カルテ」
   - SOAP形式で記録
   - S: 主訴・現病歴
   - O: 所見・検査結果
   - A: 診断・評価
   - P: 治療計画

7. **処方** `/prescriptions` (必要時)
   - 薬剤選択
   - 用法・用量
   - 日数

8. **会計** `/billing`
   - 診療報酬計算
   - 請求書発行

9. **完了ボタン** → ステータス: COMPLETED

### 1.2 再診患者

1. **患者来院**
2. **受付** `/patients` → 患者検索 → 詳細確認
3. **予約登録** `/appointments` → 診療種別: 再診 (FOLLOWUP)
4. **受付ボタン** → WAITING
5. **診療開始** → IN_PROGRESS
   - 過去カルテ参照可能: `/records?patientId=xxx`
6. **カルテ記載** → **処方** → **会計** → **完了**

---

## 2. オンライン診療フロー

### 2.1 予約〜診療開始（医師・スタッフ側）

1. **予約登録** `/appointments` → 「新規予約」
   - 「オンライン診療」スイッチをON
   - `isOnline: true` で保存

2. **予約確認** ステータス: SCHEDULED
   - 患者にはポータルで通知

3. **診療当日**

4. **受付ボタン** → WAITING
   - 患者はポータルで待機

5. **オンライン診療開始ボタン** (予約管理ページに表示)
   - VideoSession 作成
   - Daily.co room 生成
   - ステータス: IN_PROGRESS
   - 自動で `/video` ページへ遷移

6. **ビデオ通話画面** `/video`
   - カメラ・マイク制御
   - 画面共有
   - 参加者表示

7. **通話終了ボタン**
   - VideoSession 終了
   - ステータス: COMPLETED

8. **カルテ記載** → **処方** → **会計**

### 2.2 患者側フロー（ポータル）

1. **ポータルログイン** `/portal`
2. **予約確認** `/portal/appointments`
   - オンライン予約を確認
   - 診療時間を確認
3. **診療時間になったら**
   - 「診療室に入る」ボタン表示
4. **ビデオ通話参加**
   - 医師との通話開始
5. **診療終了**
6. **処方確認** `/portal/medications`
7. **請求確認** (実装予定)

---

## 3. Web問診フロー

### 3.1 問診作成（スタッフ側）

1. **問診テンプレート作成** `/questionnaire`
   - 質問項目設定
   - 回答形式設定 (テキスト/選択/数値)
   - 診療科別テンプレート
2. **問診URL発行**
   - 患者に送付

### 3.2 問診回答（患者側）

1. **問診URL受信** (メール/SMS)
2. **問診入力画面**
   - 症状入力
   - 既往歴
   - アレルギー
   - 服薬中の薬
3. **回答送信**
4. **スタッフ側で確認** `/questionnaire`
   - 回答内容表示
   - カルテに反映

---

## 4. 処方フロー

1. **診療中** カルテ作成
2. **処方追加** `/prescriptions` → 「新規処方」
   - 患者選択 (自動)
   - 薬剤検索・選択
   - 用法: 1日3回毎食後 等
   - 用量: 1錠 等
   - 日数: 7日分 等
   - 備考: ジェネリック可 等
3. **処方確定**
   - 処方箋データ保存
   - 院内処方 or 院外処方
4. **患者ポータルに反映** `/portal/medications`

---

## 5. 会計・請求フロー

1. **診療完了**
2. **請求書作成** `/billing` → 「新規請求」
   - 患者選択
   - 診療項目追加 (初診料/再診料、処置料、検査料、処方料)
   - 保険適用計算
   - 自己負担額算出
3. **請求書発行** → ステータス: SENT
4. **支払い受領** → ステータス: PAID
   - 領収書発行

---

## 6. 患者ポータル機能一覧

| ページ | パス | 機能 |
|--------|------|------|
| ダッシュボード | /portal | 概要表示、次回予約、未読通知 |
| 予約 | /portal/appointments | 予約一覧、オンライン診療入室 |
| メッセージ | /portal/messages | クリニックとのやり取り |
| 処方・お薬 | /portal/medications | 処方履歴、服薬中の薬 |
| 検査結果 | /portal/results | 検査結果閲覧 |
| 通知 | /portal/notifications | お知らせ一覧 |

---

## 7. ステータス遷移まとめ

### 予約ステータス (AppointmentStatus)

| ステータス | 日本語 | 説明 | 次のアクション |
|-----------|--------|------|---------------|
| SCHEDULED | 予約済 | 予約が入った状態 | 受付ボタン |
| CONFIRMED | 確認済 | 予約確認済み | 受付ボタン |
| WAITING | 待機中 | 受付完了、待合 | 開始ボタン |
| IN_PROGRESS | 診療中 | 診療実施中 | 完了ボタン |
| COMPLETED | 完了 | 診療終了 | - |
| CANCELLED | キャンセル | 予約取消 | - |
| NO_SHOW | 未来院 | 来院なし | - |

### ビデオセッションステータス (VideoSessionStatus)

| ステータス | 説明 |
|-----------|------|
| WAITING | セッション作成済、待機中 |
| IN_PROGRESS | 通話中 |
| COMPLETED | 通話終了 |

### 請求ステータス (InvoiceStatus)

| ステータス | 日本語 | 説明 |
|-----------|--------|------|
| DRAFT | 下書き | 作成中 |
| SENT | 発行済 | 患者に請求 |
| PAID | 支払済 | 入金確認 |
| CANCELLED | 取消 | 請求取消 |

---

## 8. 画面遷移マップ

### スタッフ側

| パス | 機能 |
|------|------|
| /patients | 患者一覧 → 患者詳細 → カルテ |
| /appointments | 予約管理 → 受付 → 診療開始 |
| /records | カルテ一覧 → カルテ詳細/編集 |
| /video | オンライン診療 (ビデオ通話) |
| /prescriptions | 処方管理 |
| /billing | 請求管理 |
| /questionnaire | Web問診 |
| /documents | 文書テンプレート |
| /ent | 耳鼻科専用 |
| /ent/dashboard | ENTダッシュボード |
| /ent/report | 聴力検査レポート |
| /ent/templates | ENTテンプレート |
| /settings | 設定 |

### 患者側

| パス | 機能 |
|------|------|
| /portal | ダッシュボード |
| /portal/appointments | 予約一覧・オンライン診療 |
| /portal/messages | メッセージ |
| /portal/medications | 処方・お薬 |
| /portal/results | 検査結果 |
| /portal/notifications | 通知 |

---

## 9. API エンドポイント対応表

| フロー | Router | Procedure |
|--------|--------|-----------|
| 患者登録 | patient | create |
| 患者検索 | patient | list, search |
| 予約作成 | appointment | create |
| 受付 | appointment | updateStatus (→ WAITING) |
| 診療開始 | appointment | updateStatus (→ IN_PROGRESS) |
| オンライン診療開始 | video | createSession, getToken, startSession |
| カルテ作成 | record | create |
| 処方作成 | prescription | create |
| 請求作成 | billing | createInvoice |
| 患者自身の予約 | portal | myAppointments |
| 患者自身のメッセージ | portal | myMessages |

---

## 10. よくある操作手順

### 本日の診療を始める

1. `/appointments` を開く
2. カレンダーで本日を選択
3. 予約一覧を確認
4. 来院患者の「受付」ボタンをクリック
5. 順番に「開始」(対面) or 「オンライン診療開始」(オンライン)

### 新患を登録して診療する

1. `/patients` → 「新規患者登録」
2. 情報入力 → 保存
3. `/appointments` → 「新規予約」
4. 今登録した患者を選択
5. 担当医・時間・種別を設定
6. 受付 → 診療開始 → カルテ記載

### オンライン診療を実施する

1. `/appointments` で該当予約を確認
2. 「受付」ボタン
3. 「オンライン診療開始」ボタン
4. 自動でビデオ画面に遷移
5. 患者接続を待つ
6. 診療実施
7. 「通話終了」ボタン
8. カルテ記載
