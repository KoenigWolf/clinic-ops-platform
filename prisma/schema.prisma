generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== テナント・認証 ====================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  patients      Patient[]
  appointments  Appointment[]
  invoices      Invoice[]
  auditLogs     AuditLog[]

  @@map("tenants")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  emailVerified  DateTime?
  passwordHash   String?
  name           String
  image          String?
  role           UserRole  @default(STAFF)
  specialization String?
  licenseNumber  String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  accounts       Account[]
  sessions       Session[]
  medicalRecords MedicalRecord[]
  prescriptions  Prescription[]
  appointments   Appointment[]   @relation("DoctorAppointments")
  auditLogs      AuditLog[]

  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  STAFF
  PATIENT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== 患者管理 ====================

model Patient {
  id              String    @id @default(cuid())
  patientNumber   String
  firstName       String
  lastName        String
  firstNameKana   String?
  lastNameKana    String?
  dateOfBirth     DateTime
  gender          Gender
  bloodType       BloodType?
  phone           String?
  email           String?
  address         String?
  postalCode      String?
  emergencyContact String?
  emergencyPhone  String?
  allergies       String?
  medicalHistory  String?
  insuranceNumber String?
  insuranceType   String?
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  medicalRecords  MedicalRecord[]
  prescriptions   Prescription[]
  labResults      LabResult[]
  medicalImages   MedicalImage[]
  appointments    Appointment[]
  invoices        Invoice[]

  @@unique([tenantId, patientNumber])
  @@index([tenantId])
  @@index([lastName, firstName])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
}

// ==================== 診療記録 (SOAP形式) ====================

model MedicalRecord {
  id          String   @id @default(cuid())
  recordDate  DateTime @default(now())

  // SOAP形式
  subjective  String?  @db.Text // 主訴・現病歴
  objective   String?  @db.Text // 身体所見・検査所見
  assessment  String?  @db.Text // 評価・診断
  plan        String?  @db.Text // 治療計画

  chiefComplaint String? // 主訴
  diagnosis      String? // 診断名
  vitalSigns     Json?   // バイタルサイン

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation(fields: [doctorId], references: [id])

  prescriptions Prescription[]
  labResults    LabResult[]
  medicalImages MedicalImage[]

  @@index([patientId])
  @@index([doctorId])
  @@index([recordDate])
  @@map("medical_records")
}

// ==================== 処方管理 ====================

model Prescription {
  id                String   @id @default(cuid())
  prescriptionDate  DateTime @default(now())

  medicationName    String
  dosage            String   // 用量
  frequency         String   // 用法 (1日3回など)
  duration          Int      // 処方日数
  quantity          Int      // 総数量
  unit              String   // 単位 (錠、mg等)
  instructions      String?  // 服用方法・注意事項

  status            PrescriptionStatus @default(PENDING)
  dispensedAt       DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation(fields: [doctorId], references: [id])

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@map("prescriptions")
}

enum PrescriptionStatus {
  PENDING
  DISPENSED
  CANCELLED
}

// ==================== 検査結果 ====================

model LabResult {
  id           String   @id @default(cuid())
  testDate     DateTime @default(now())
  testName     String
  testCode     String?
  result       String
  unit         String?
  referenceMin Float?
  referenceMax Float?
  isAbnormal   Boolean  @default(false)
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([testDate])
  @@map("lab_results")
}

// ==================== 医療画像 ====================

model MedicalImage {
  id          String    @id @default(cuid())
  imageDate   DateTime  @default(now())
  imageType   ImageType
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("medical_images")
}

enum ImageType {
  XRAY
  CT
  MRI
  ULTRASOUND
  ENDOSCOPY
  OTHER
}

// ==================== 予約管理 ====================

model Appointment {
  id              String            @id @default(cuid())
  appointmentDate DateTime
  startTime       DateTime
  endTime         DateTime
  type            AppointmentType
  status          AppointmentStatus @default(SCHEDULED)
  reason          String?
  notes           String?

  // オンライン診療用
  isOnline        Boolean           @default(false)
  videoRoomUrl    String?
  videoRoomName   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation("DoctorAppointments", fields: [doctorId], references: [id])

  videoSession VideoSession?

  @@index([tenantId])
  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@map("appointments")
}

enum AppointmentType {
  INITIAL       // 初診
  FOLLOWUP      // 再診
  CONSULTATION  // 相談
  CHECKUP       // 健診
  EMERGENCY     // 緊急
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  WAITING      // 待合室
  IN_PROGRESS  // 診療中
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== ビデオ診療セッション ====================

model VideoSession {
  id            String             @id @default(cuid())
  roomName      String             @unique
  roomUrl       String
  status        VideoSessionStatus @default(CREATED)
  startedAt     DateTime?
  endedAt       DateTime?
  duration      Int?               // 秒数

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("video_sessions")
}

enum VideoSessionStatus {
  CREATED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== 請求管理 ====================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime?

  subtotal      Int           // 小計 (円)
  tax           Int           // 消費税
  total         Int           // 合計

  status        InvoiceStatus @default(DRAFT)
  paidAt        DateTime?
  paymentMethod String?

  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  items InvoiceItem[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([patientId])
  @@map("invoices")
}

model InvoiceItem {
  id          String @id @default(cuid())
  description String
  quantity    Int
  unitPrice   Int
  amount      Int

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ==================== 監査ログ ====================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
