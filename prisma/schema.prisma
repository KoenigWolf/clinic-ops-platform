generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== テナント・認証 ====================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  patients      Patient[]
  appointments  Appointment[]
  invoices      Invoice[]
  auditLogs     AuditLog[]
  entDiagnosisTemplates EntDiagnosisTemplate[]

  // 問診・文書テンプレート
  questionnaireTemplates QuestionnaireTemplate[]
  documentTemplates      DocumentTemplate[]

  @@map("tenants")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  emailVerified  DateTime?
  passwordHash   String?
  name           String
  image          String?
  role           UserRole  @default(STAFF)
  specialization String?
  licenseNumber  String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  accounts       Account[]
  sessions       Session[]
  medicalRecords MedicalRecord[]
  prescriptions  Prescription[]
  appointments   Appointment[]   @relation("DoctorAppointments")
  auditLogs      AuditLog[]

  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  STAFF
  PATIENT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== 患者管理 ====================

model Patient {
  id                    String    @id @default(cuid())
  patientNumber         String
  
  // 基本情報
  firstName             String
  lastName              String
  firstNameKana         String    // 必須に変更
  lastNameKana          String    // 必須に変更
  dateOfBirth           DateTime
  gender                Gender
  bloodType             BloodType?
  
  // 住所・連絡先
  phone                 String    // 必須に変更
  email                 String?
  address               String    // 必須に変更
  postalCode            String?
  emergencyContact      String?
  emergencyRelationship String?   // 新規追加: 続柄
  emergencyPhone        String?
  
  // マイナンバーカード
  myNumberConsent       Boolean   @default(false) // 新規追加
  
  // 来院情報
  firstVisitDate        DateTime? // 新規追加
  lastVisitDate         DateTime? // 新規追加
  
  // 医療情報
  allergies             String?   @db.Text
  medicalHistory        String?   @db.Text
  familyHistory         String?   @db.Text // 新規追加
  contraindications     String?   @db.Text // 新規追加: 禁忌情報
  currentMedications    String?   @db.Text // 新規追加: 服薬中の薬
  healthCheckInfo       String?   @db.Text // 新規追加: 特定健診情報
  pregnant              Boolean?  // 新規追加: 妊娠中
  
  // 保険情報（オンライン資格確認対応）
  insurerNumber         String    // 新規追加: 保険者番号（必須）
  insuredNumber         String    // 新規追加: 被保険者番号（必須）
  insuranceNumber       String?   // 既存: 保険証番号（保持）
  insuranceType         InsuranceType? // enumに変更
  insuranceSymbol       String?   // 新規追加: 記号
  insuranceExpiration   DateTime? // 新規追加: 有効期限
  insuranceCategory     InsuranceCategory? // 新規追加: 本人/家族区分
  limitCertification    String?   // 新規追加: 限度額認定
  
  // 公費負担医療
  publicPayerNumber     String?   // 新規追加: 公費負担者番号
  publicRecipientNumber String?   // 新規追加: 公費受給者番号
  publicCategory        PublicCategory? // 新規追加: 公費区分
  publicExpiration      DateTime? // 新規追加: 公費有効期限
  
  // その他
  notes                 String?   @db.Text
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // テナント関連
  tenantId              String
  tenant                Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // リレーション
  medicalRecords        MedicalRecord[]
  prescriptions         Prescription[]
  labResults            LabResult[]
  medicalImages         MedicalImage[]
  appointments          Appointment[]
  invoices              Invoice[]
  audiometryTests       AudiometryTest[]
  tympanometryTests     TympanometryTest[]
  vestibularTests       VestibularTest[]
  endoscopyExams        EndoscopyExam[]
  allergyTests          AllergyTest[]
  questionnaireResponses QuestionnaireResponse[]
  documents             Document[]
  messages              PatientMessage[]
  notifications         PatientNotification[]
  medicationRecords     MedicationRecord[]

  @@unique([tenantId, patientNumber])
  @@index([tenantId])
  @@index([lastName, firstName])
  @@index([lastNameKana, firstNameKana]) // 新規追加: カナ検索用
  @@map("patients")
}

// 既存のenum
enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
}

// 新規追加のenum
enum InsuranceType {
  NATIONAL_HEALTH_INSURANCE    // 国民健康保険
  EMPLOYEES_INSURANCE          // 社会保険(被用者保険)
  MUTUAL_AID_INSURANCE         // 共済組合
  LATE_STAGE_ELDERLY           // 後期高齢者医療
  OTHER                        // その他
}

enum InsuranceCategory {
  INSURED                      // 本人(被保険者)
  DEPENDENT                    // 家族(被扶養者)
}

enum PublicCategory {
  LIVELIHOOD_PROTECTION        // 生活保護
  INTRACTABLE_DISEASE          // 難病医療
  MENTAL_HEALTH                // 精神通院医療
  CHILD_MEDICAL                // 小児慢性特定疾病
  ATOMIC_BOMB_SURVIVOR         // 原爆被爆者援護
  SPECIFIED_DISEASE            // 特定疾患
  MATERNAL_HEALTH              // 母子保健
  OTHER                        // その他
}

// ==================== 診療記録 (SOAP形式) ====================

model MedicalRecord {
  id          String   @id @default(cuid())
  recordDate  DateTime @default(now())

  // SOAP形式
  subjective  String?  @db.Text // 主訴・現病歴
  objective   String?  @db.Text // 身体所見・検査所見
  assessment  String?  @db.Text // 評価・診断
  plan        String?  @db.Text // 治療計画

  chiefComplaint String? // 主訴
  diagnosis      String? // 診断名
  vitalSigns     Json?   // バイタルサイン

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation(fields: [doctorId], references: [id])

  prescriptions Prescription[]
  labResults    LabResult[]
  medicalImages MedicalImage[]
  audiometryTests   AudiometryTest[]
  tympanometryTests TympanometryTest[]
  vestibularTests   VestibularTest[]
  endoscopyExams    EndoscopyExam[]
  allergyTests      AllergyTest[]

  // 問診・文書
  questionnaireResponses QuestionnaireResponse[]
  documents              Document[]

  @@index([patientId])
  @@index([doctorId])
  @@index([recordDate])
  @@map("medical_records")
}

// ==================== 処方管理 ====================

model Prescription {
  id                String   @id @default(cuid())
  prescriptionDate  DateTime @default(now())

  medicationName    String
  dosage            String   // 用量
  frequency         String   // 用法 (1日3回など)
  duration          Int      // 処方日数
  quantity          Int      // 総数量
  unit              String   // 単位 (錠、mg等)
  instructions      String?  // 服用方法・注意事項

  status            PrescriptionStatus @default(PENDING)
  dispensedAt       DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation(fields: [doctorId], references: [id])

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  medicationRecords MedicationRecord[]

  @@index([patientId])
  @@index([doctorId])
  @@map("prescriptions")
}

enum PrescriptionStatus {
  PENDING
  DISPENSED
  CANCELLED
}

// ==================== 検査結果 ====================

model LabResult {
  id           String   @id @default(cuid())
  testDate     DateTime @default(now())
  testName     String
  testCode     String?
  result       String
  unit         String?
  referenceMin Float?
  referenceMax Float?
  isAbnormal   Boolean  @default(false)
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([testDate])
  @@map("lab_results")
}

// ==================== 医療画像 ====================

model MedicalImage {
  id          String    @id @default(cuid())
  imageDate   DateTime  @default(now())
  imageType   ImageType
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("medical_images")
}

enum ImageType {
  XRAY
  CT
  MRI
  ULTRASOUND
  ENDOSCOPY
  OTHER
}

// ==================== 予約管理 ====================

model Appointment {
  id              String            @id @default(cuid())
  appointmentDate DateTime
  startTime       DateTime
  endTime         DateTime
  type            AppointmentType
  status          AppointmentStatus @default(SCHEDULED)
  reason          String?
  notes           String?

  // オンライン診療用
  isOnline        Boolean           @default(false)
  videoRoomUrl    String?
  videoRoomName   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation("DoctorAppointments", fields: [doctorId], references: [id])

  videoSession VideoSession?
  questionnaireResponses QuestionnaireResponse[]

  @@index([tenantId])
  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@map("appointments")
}

enum AppointmentType {
  INITIAL       // 初診
  FOLLOWUP      // 再診
  CONSULTATION  // 相談
  CHECKUP       // 健診
  EMERGENCY     // 緊急
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  WAITING      // 待合室
  IN_PROGRESS  // 診療中
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== ビデオ診療セッション ====================

model VideoSession {
  id            String             @id @default(cuid())
  roomName      String             @unique
  roomUrl       String
  status        VideoSessionStatus @default(CREATED)
  startedAt     DateTime?
  endedAt       DateTime?
  duration      Int?               // 秒数

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("video_sessions")
}

enum VideoSessionStatus {
  CREATED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== 請求管理 ====================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime?

  subtotal      Int           // 小計 (円)
  tax           Int           // 消費税
  total         Int           // 合計

  status        InvoiceStatus @default(DRAFT)
  paidAt        DateTime?
  paymentMethod String?

  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  items InvoiceItem[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([patientId])
  @@map("invoices")
}

model InvoiceItem {
  id          String @id @default(cuid())
  description String
  quantity    Int
  unitPrice   Int
  amount      Int

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ==================== 監査ログ ====================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== 耳鼻科専用機能 ====================

// 聴力検査（オージオグラム）
model AudiometryTest {
  id        String   @id @default(cuid())
  testDate  DateTime @default(now())
  testType  AudiometryType @default(PURE_TONE)

  // 右耳 気導聴力 (dB) - 周波数ごと
  rightAir125   Int?
  rightAir250   Int?
  rightAir500   Int?
  rightAir1000  Int?
  rightAir2000  Int?
  rightAir4000  Int?
  rightAir8000  Int?

  // 左耳 気導聴力 (dB)
  leftAir125    Int?
  leftAir250    Int?
  leftAir500    Int?
  leftAir1000   Int?
  leftAir2000   Int?
  leftAir4000   Int?
  leftAir8000   Int?

  // 右耳 骨導聴力 (dB)
  rightBone250  Int?
  rightBone500  Int?
  rightBone1000 Int?
  rightBone2000 Int?
  rightBone4000 Int?

  // 左耳 骨導聴力 (dB)
  leftBone250   Int?
  leftBone500   Int?
  leftBone1000  Int?
  leftBone2000  Int?
  leftBone4000  Int?

  // 語音聴力検査
  rightSpeechDiscrimination Int? // 右耳語音明瞭度 (%)
  leftSpeechDiscrimination  Int? // 左耳語音明瞭度 (%)

  interpretation String? // 所見・解釈
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([testDate])
  @@map("audiometry_tests")
}

enum AudiometryType {
  PURE_TONE      // 純音聴力検査
  SPEECH         // 語音聴力検査
  IMPEDANCE      // インピーダンス検査
  ABR            // 聴性脳幹反応
  OAE            // 耳音響放射
}

// ティンパノメトリー（鼓膜検査）
model TympanometryTest {
  id       String   @id @default(cuid())
  testDate DateTime @default(now())

  // 右耳
  rightType       TympanogramType?
  rightPeakPressure Int?  // ピーク圧 (daPa)
  rightCompliance   Float? // コンプライアンス (ml)
  rightEarCanalVol  Float? // 外耳道容積 (ml)

  // 左耳
  leftType        TympanogramType?
  leftPeakPressure  Int?
  leftCompliance    Float?
  leftEarCanalVol   Float?

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("tympanometry_tests")
}

enum TympanogramType {
  A   // 正常
  As  // 硬化
  Ad  // 弛緩
  B   // 扁平（滲出性中耳炎など）
  C   // 陰圧（耳管機能不全）
}

// 平衡機能検査（めまい検査）
model VestibularTest {
  id       String   @id @default(cuid())
  testDate DateTime @default(now())
  testType VestibularTestType @default(CALORIC)

  // 臨床情報
  chiefComplaint    String?  // 主訴
  vertigoType       String?  // めまいの種類
  nystagmusFindings String?  // 眼振所見
  rombergTest       String?  // Romberg検査
  mannTest          String?  // Mann検査
  caloricResponse   String?  // 温度刺激検査所見
  headImpulseTest   String?  // Head Impulse Test
  dixHallpikeResult String?  // Dix-Hallpike検査

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("vestibular_tests")
}

enum VestibularTestType {
  CALORIC       // 温度刺激検査
  POSTUROGRAPHY // 重心動揺検査
  ENG           // 電気眼振図
  VNG           // ビデオ眼振図
  VHIT          // Video Head Impulse Test
  VEMP          // 前庭誘発筋電位
  ROTATION      // 回転検査
}

// 内視鏡検査記録
model EndoscopyExam {
  id       String   @id @default(cuid())
  examDate DateTime @default(now())
  examType EndoscopyType @default(NASAL)

  // 鼻腔所見
  nasalFindings     String? // 鼻腔所見（総合）
  nasalSeptum       String? // 鼻中隔
  inferiorTurbinate String? // 下鼻甲介
  middleMeatus      String? // 中鼻道

  // 咽頭所見
  pharyngealFindings String? // 咽頭所見
  tonsils            String? // 扁桃

  // 喉頭所見
  laryngealFindings String? // 喉頭所見
  vocalCords        String? // 声帯所見
  epiglottis        String? // 喉頭蓋

  // 耳鏡検査
  otoscopyRight String? // 右耳鏡所見
  otoscopyLeft  String? // 左耳鏡所見

  // 画像
  imageUrls Json @default("[]") // 画像URL配列

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("endoscopy_exams")
}

enum EndoscopyType {
  NASAL      // 鼻腔内視鏡
  PHARYNGEAL // 咽頭内視鏡
  LARYNGEAL  // 喉頭内視鏡
  OTOSCOPY   // 耳鏡検査
}

// アレルギー検査
model AllergyTest {
  id       String   @id @default(cuid())
  testDate DateTime @default(now())
  testType AllergyTestType

  // 検査結果 (JSON形式で保存)
  results  Json // { "スギ": 4, "ヒノキ": 3, "ダニ": 2, ... }

  totalIgE        Float? // 総IgE値
  eosinophilCount Int?   // 好酸球数

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("allergy_tests")
}

enum AllergyTestType {
  RAST       // RAST検査（特異的IgE）
  SKIN_PRICK // 皮膚プリックテスト
  MAST       // MAST検査
  CAP        // CAP (UniCAP)
}

// 耳鼻科診断テンプレート
model EntDiagnosisTemplate {
  id          String   @id @default(cuid())
  name        String   // テンプレート名
  category    EntCategory
  icdCode     String?  // ICD-10コード

  // SOAP テンプレート
  subjectiveTemplate  String? // 主訴テンプレート
  objectiveTemplate   String? // 所見テンプレート
  assessmentTemplate  String? // 評価テンプレート
  planTemplate        String? // 計画テンプレート

  // よく使う処方
  commonPrescriptions Json? // [{medicationName, dosage, frequency}]

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@map("ent_diagnosis_templates")
}

enum EntCategory {
  EAR      // 耳疾患
  NOSE     // 鼻疾患
  THROAT   // 咽喉頭疾患
  ALLERGY  // アレルギー
  VERTIGO  // めまい
  OTHER    // その他
}

// ==================== Web問診システム ====================

model QuestionnaireTemplate {
  id          String   @id @default(cuid())
  name        String   // テンプレート名
  description String?  // 説明
  category    QuestionnaireCategory @default(GENERAL)

  // 問診項目 (JSON配列)
  questions   Json     // [{id, type, question, options?, required, category}]

  // 設定
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false) // デフォルト問診票
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  responses   QuestionnaireResponse[]

  @@index([tenantId])
  @@index([category])
  @@map("questionnaire_templates")
}

model QuestionnaireResponse {
  id          String   @id @default(cuid())

  // 回答内容 (JSON)
  answers     Json     // {questionId: answer}

  // 自動生成されたサマリー
  summary     String?  @db.Text

  // SOAPへの転記用テキスト
  subjective  String?  @db.Text // 主訴・現病歴

  // ステータス
  status      QuestionnaireStatus @default(SUBMITTED)
  submittedAt DateTime @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  templateId  String
  template    QuestionnaireTemplate @relation(fields: [templateId], references: [id])

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  // カルテへの取り込み - onDelete: Restrict により削除不可（監査保全）
  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id], onDelete: Restrict)

  @@index([patientId])
  @@index([templateId])
  @@index([appointmentId])
  @@index([status])
  @@map("questionnaire_responses")
}

enum QuestionnaireCategory {
  GENERAL      // 一般
  FIRST_VISIT  // 初診
  FOLLOW_UP    // 再診
  PEDIATRIC    // 小児科
  INTERNAL     // 内科
  ENT          // 耳鼻科
  DERMATOLOGY  // 皮膚科
  ORTHOPEDIC   // 整形外科
  MENTAL       // 心療内科
  OTHER        // その他
}

enum QuestionnaireStatus {
  DRAFT      // 下書き
  SUBMITTED  // 提出済み
  REVIEWED   // 確認済み
  APPLIED    // カルテ適用済み
}

// ==================== 文書テンプレート ====================

model DocumentTemplate {
  id          String   @id @default(cuid())
  name        String   // テンプレート名
  category    DocumentCategory

  // テンプレート内容 (プレースホルダー対応)
  content     String   @db.Text

  // メタ情報
  description String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  documents   Document[]

  @@index([tenantId])
  @@index([category])
  @@map("document_templates")
}

model Document {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    DocumentCategory

  // 発行情報
  issuedAt    DateTime @default(now())
  issuedBy    String?

  // PDF生成
  pdfUrl      String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  templateId  String?
  template    DocumentTemplate? @relation(fields: [templateId], references: [id])

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([category])
  @@map("documents")
}

enum DocumentCategory {
  REFERRAL         // 紹介状
  CERTIFICATE      // 診断書
  MEDICAL_CERT     // 医療証明書
  PRESCRIPTION     // 処方箋
  CONSENT          // 同意書
  SICK_LEAVE       // 休職証明書
  INSURANCE        // 保険関係書類
  OTHER            // その他
}

// ==================== 患者ポータル ====================

model PatientMessage {
  id          String   @id @default(cuid())
  subject     String?  // 件名
  content     String   @db.Text

  // 送信者情報
  senderType  MessageSenderType
  senderId    String   // User ID or Patient ID

  // 既読管理
  isRead      Boolean  @default(false)
  readAt      DateTime?

  // 添付ファイル
  attachments Json?    // [{name, url, type}]

  createdAt   DateTime @default(now())

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([createdAt])
  @@map("patient_messages")
}

model PatientNotification {
  id          String   @id @default(cuid())
  title       String
  message     String
  type        NotificationType

  // リンク先
  linkUrl     String?

  // 既読管理
  isRead      Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime @default(now())

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([isRead])
  @@map("patient_notifications")
}

model MedicationRecord {
  id          String   @id @default(cuid())

  // お薬情報
  medicationName String
  dosage      String?
  frequency   String?
  startDate   DateTime?
  endDate     DateTime?

  // 処方元
  prescribedBy String?
  pharmacyName String?

  // メモ
  notes       String?

  // 種類
  type        MedicationType @default(PRESCRIPTION)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  prescriptionId String?
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id])

  @@index([patientId])
  @@map("medication_records")
}

enum MessageSenderType {
  STAFF    // 医療スタッフ
  PATIENT  // 患者
  SYSTEM   // システム通知
}

enum NotificationType {
  APPOINTMENT  // 予約関連
  LAB_RESULT   // 検査結果
  PRESCRIPTION // 処方関連
  MESSAGE      // メッセージ
  REMINDER     // リマインダー
  GENERAL      // 一般
}

enum MedicationType {
  PRESCRIPTION // 処方薬
  OTC          // 市販薬
  SUPPLEMENT   // サプリメント
}
