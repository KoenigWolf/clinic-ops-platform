generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== テナント・認証 ====================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  patients      Patient[]
  appointments  Appointment[]
  invoices      Invoice[]
  auditLogs     AuditLog[]
  entDiagnosisTemplates EntDiagnosisTemplate[]

  @@map("tenants")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  emailVerified  DateTime?
  passwordHash   String?
  name           String
  image          String?
  role           UserRole  @default(STAFF)
  specialization String?
  licenseNumber  String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  accounts       Account[]
  sessions       Session[]
  medicalRecords MedicalRecord[]
  prescriptions  Prescription[]
  appointments   Appointment[]   @relation("DoctorAppointments")
  auditLogs      AuditLog[]

  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  STAFF
  PATIENT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== 患者管理 ====================

model Patient {
  id              String    @id @default(cuid())
  patientNumber   String
  firstName       String
  lastName        String
  firstNameKana   String?
  lastNameKana    String?
  dateOfBirth     DateTime
  gender          Gender
  bloodType       BloodType?
  phone           String?
  email           String?
  address         String?
  postalCode      String?
  emergencyContact String?
  emergencyPhone  String?
  allergies       String?
  medicalHistory  String?
  insuranceNumber String?
  insuranceType   String?
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  medicalRecords  MedicalRecord[]
  prescriptions   Prescription[]
  labResults      LabResult[]
  medicalImages   MedicalImage[]
  appointments    Appointment[]
  invoices        Invoice[]
  audiometryTests   AudiometryTest[]
  tympanometryTests TympanometryTest[]
  vestibularTests   VestibularTest[]
  endoscopyExams    EndoscopyExam[]
  allergyTests      AllergyTest[]

  @@unique([tenantId, patientNumber])
  @@index([tenantId])
  @@index([lastName, firstName])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
}

// ==================== 診療記録 (SOAP形式) ====================

model MedicalRecord {
  id          String   @id @default(cuid())
  recordDate  DateTime @default(now())

  // SOAP形式
  subjective  String?  @db.Text // 主訴・現病歴
  objective   String?  @db.Text // 身体所見・検査所見
  assessment  String?  @db.Text // 評価・診断
  plan        String?  @db.Text // 治療計画

  chiefComplaint String? // 主訴
  diagnosis      String? // 診断名
  vitalSigns     Json?   // バイタルサイン

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation(fields: [doctorId], references: [id])

  prescriptions Prescription[]
  labResults    LabResult[]
  medicalImages MedicalImage[]
  audiometryTests   AudiometryTest[]
  tympanometryTests TympanometryTest[]
  vestibularTests   VestibularTest[]
  endoscopyExams    EndoscopyExam[]
  allergyTests      AllergyTest[]

  @@index([patientId])
  @@index([doctorId])
  @@index([recordDate])
  @@map("medical_records")
}

// ==================== 処方管理 ====================

model Prescription {
  id                String   @id @default(cuid())
  prescriptionDate  DateTime @default(now())

  medicationName    String
  dosage            String   // 用量
  frequency         String   // 用法 (1日3回など)
  duration          Int      // 処方日数
  quantity          Int      // 総数量
  unit              String   // 単位 (錠、mg等)
  instructions      String?  // 服用方法・注意事項

  status            PrescriptionStatus @default(PENDING)
  dispensedAt       DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation(fields: [doctorId], references: [id])

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@map("prescriptions")
}

enum PrescriptionStatus {
  PENDING
  DISPENSED
  CANCELLED
}

// ==================== 検査結果 ====================

model LabResult {
  id           String   @id @default(cuid())
  testDate     DateTime @default(now())
  testName     String
  testCode     String?
  result       String
  unit         String?
  referenceMin Float?
  referenceMax Float?
  isAbnormal   Boolean  @default(false)
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([testDate])
  @@map("lab_results")
}

// ==================== 医療画像 ====================

model MedicalImage {
  id          String    @id @default(cuid())
  imageDate   DateTime  @default(now())
  imageType   ImageType
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("medical_images")
}

enum ImageType {
  XRAY
  CT
  MRI
  ULTRASOUND
  ENDOSCOPY
  OTHER
}

// ==================== 予約管理 ====================

model Appointment {
  id              String            @id @default(cuid())
  appointmentDate DateTime
  startTime       DateTime
  endTime         DateTime
  type            AppointmentType
  status          AppointmentStatus @default(SCHEDULED)
  reason          String?
  notes           String?

  // オンライン診療用
  isOnline        Boolean           @default(false)
  videoRoomUrl    String?
  videoRoomName   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User @relation("DoctorAppointments", fields: [doctorId], references: [id])

  videoSession VideoSession?

  @@index([tenantId])
  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@map("appointments")
}

enum AppointmentType {
  INITIAL       // 初診
  FOLLOWUP      // 再診
  CONSULTATION  // 相談
  CHECKUP       // 健診
  EMERGENCY     // 緊急
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  WAITING      // 待合室
  IN_PROGRESS  // 診療中
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== ビデオ診療セッション ====================

model VideoSession {
  id            String             @id @default(cuid())
  roomName      String             @unique
  roomUrl       String
  status        VideoSessionStatus @default(CREATED)
  startedAt     DateTime?
  endedAt       DateTime?
  duration      Int?               // 秒数

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("video_sessions")
}

enum VideoSessionStatus {
  CREATED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== 請求管理 ====================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime?

  subtotal      Int           // 小計 (円)
  tax           Int           // 消費税
  total         Int           // 合計

  status        InvoiceStatus @default(DRAFT)
  paidAt        DateTime?
  paymentMethod String?

  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  items InvoiceItem[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([patientId])
  @@map("invoices")
}

model InvoiceItem {
  id          String @id @default(cuid())
  description String
  quantity    Int
  unitPrice   Int
  amount      Int

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ==================== 監査ログ ====================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== 耳鼻科専用機能 ====================

// 聴力検査（オージオグラム）
model AudiometryTest {
  id        String   @id @default(cuid())
  testDate  DateTime @default(now())
  testType  AudiometryType @default(PURE_TONE)

  // 右耳 気導聴力 (dB) - 周波数ごと
  rightAir125   Int?
  rightAir250   Int?
  rightAir500   Int?
  rightAir1000  Int?
  rightAir2000  Int?
  rightAir4000  Int?
  rightAir8000  Int?

  // 左耳 気導聴力 (dB)
  leftAir125    Int?
  leftAir250    Int?
  leftAir500    Int?
  leftAir1000   Int?
  leftAir2000   Int?
  leftAir4000   Int?
  leftAir8000   Int?

  // 右耳 骨導聴力 (dB)
  rightBone250  Int?
  rightBone500  Int?
  rightBone1000 Int?
  rightBone2000 Int?
  rightBone4000 Int?

  // 左耳 骨導聴力 (dB)
  leftBone250   Int?
  leftBone500   Int?
  leftBone1000  Int?
  leftBone2000  Int?
  leftBone4000  Int?

  // 語音聴力検査
  rightSpeechDiscrimination Int? // 右耳語音明瞭度 (%)
  leftSpeechDiscrimination  Int? // 左耳語音明瞭度 (%)

  interpretation String? // 所見・解釈
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([testDate])
  @@map("audiometry_tests")
}

enum AudiometryType {
  PURE_TONE      // 純音聴力検査
  SPEECH         // 語音聴力検査
  IMPEDANCE      // インピーダンス検査
  ABR            // 聴性脳幹反応
  OAE            // 耳音響放射
}

// ティンパノメトリー（鼓膜検査）
model TympanometryTest {
  id       String   @id @default(cuid())
  testDate DateTime @default(now())

  // 右耳
  rightType       TympanogramType?
  rightPeakPressure Int?  // ピーク圧 (daPa)
  rightCompliance   Float? // コンプライアンス (ml)
  rightEarCanalVol  Float? // 外耳道容積 (ml)

  // 左耳
  leftType        TympanogramType?
  leftPeakPressure  Int?
  leftCompliance    Float?
  leftEarCanalVol   Float?

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("tympanometry_tests")
}

enum TympanogramType {
  TYPE_A   // 正常
  TYPE_AS  // 硬化
  TYPE_AD  // 弛緩
  TYPE_B   // 扁平（滲出性中耳炎など）
  TYPE_C   // 陰圧（耳管機能不全）
}

// 平衡機能検査（めまい検査）
model VestibularTest {
  id       String   @id @default(cuid())
  testDate DateTime @default(now())
  testType VestibularTestType

  // 眼振検査
  spontaneousNystagmus    Boolean? // 自発眼振
  nystagmusDirection      String?  // 眼振方向
  nystagmusIntensity      Int?     // 眼振強度 (度/秒)

  // 頭位・頭位変換眼振検査
  positionalNystagmus     Boolean?
  positionalNystagmusType String?

  // カロリックテスト
  rightCaloricResponse    Int?  // CP値
  leftCaloricResponse     Int?
  canalParesis            Int?  // CP (%)
  directionalPreponderance Int? // DP (%)

  // 重心動揺検査
  swayArea                Float? // 動揺面積 (cm²)
  swayLength              Float? // 総軌跡長 (cm)
  rombergRatio            Float? // ロンベルグ率

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("vestibular_tests")
}

enum VestibularTestType {
  ENG           // 電気眼振図
  VNG           // ビデオ眼振図
  CALORIC       // カロリックテスト
  POSTUROGRAPHY // 重心動揺検査
  VEMP          // 前庭誘発筋電位
  VHIT          // Video Head Impulse Test
}

// 内視鏡検査記録
model EndoscopyExam {
  id       String   @id @default(cuid())
  examDate DateTime @default(now())
  examType EndoscopyType

  // 所見
  nasalCavityRight    String? // 右鼻腔所見
  nasalCavityLeft     String? // 左鼻腔所見
  nasopharynx         String? // 上咽頭所見
  oropharynx          String? // 中咽頭所見
  hypopharynx         String? // 下咽頭所見
  larynx              String? // 喉頭所見
  vocalCords          String? // 声帯所見

  // 画像
  imageUrls           Json?   // 画像URL配列

  interpretation      String?
  notes               String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("endoscopy_exams")
}

enum EndoscopyType {
  NASAL          // 鼻腔内視鏡
  NASOPHARYNGEAL // 上咽頭内視鏡
  LARYNGEAL      // 喉頭内視鏡
  FLEXIBLE       // 軟性内視鏡
}

// アレルギー検査
model AllergyTest {
  id       String   @id @default(cuid())
  testDate DateTime @default(now())
  testType AllergyTestType

  // 検査結果 (JSON形式で保存)
  results  Json // { "スギ": 4, "ヒノキ": 3, "ダニ": 2, ... }

  totalIgE        Float? // 総IgE値
  eosinophilCount Int?   // 好酸球数

  interpretation String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@map("allergy_tests")
}

enum AllergyTestType {
  RAST       // RAST検査（特異的IgE）
  SKIN_PRICK // 皮膚プリックテスト
  PATCH      // パッチテスト
  MAST       // MAST検査
  VIEW_ALLERGY // View アレルギー39
}

// 耳鼻科診断テンプレート
model EntDiagnosisTemplate {
  id          String   @id @default(cuid())
  name        String   // テンプレート名
  category    EntCategory
  icdCode     String?  // ICD-10コード

  // SOAP テンプレート
  subjectiveTemplate  String? // 主訴テンプレート
  objectiveTemplate   String? // 所見テンプレート
  assessmentTemplate  String? // 評価テンプレート
  planTemplate        String? // 計画テンプレート

  // よく使う処方
  commonPrescriptions Json? // [{medicationName, dosage, frequency}]

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@map("ent_diagnosis_templates")
}

enum EntCategory {
  EAR_INFECTION      // 耳感染症（中耳炎など）
  HEARING_LOSS       // 難聴
  TINNITUS           // 耳鳴
  VERTIGO            // めまい
  NASAL_ALLERGY      // アレルギー性鼻炎
  SINUSITIS          // 副鼻腔炎
  EPISTAXIS          // 鼻出血
  PHARYNGITIS        // 咽頭炎
  TONSILLITIS        // 扁桃炎
  LARYNGITIS         // 喉頭炎
  VOCAL_DISORDER     // 音声障害
  SLEEP_APNEA        // 睡眠時無呼吸
  OTHER              // その他
}
